stages:
  - build
  - release

build_package:
  stage: build
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Debugging file structure"
    - echo "CI_PROJECT_DIR is ${CI_PROJECT_DIR}"
    - ls -la "${CI_PROJECT_DIR}"
    - VERSIONED_PACKAGE_NAME="gitlab-monitor-${CI_COMMIT_TAG}.tar.gz"
    - LATEST_PACKAGE_NAME="gitlab-monitor-latest.tar.gz"
    - echo "Archiving project files"
    - tar -C "${CI_PROJECT_DIR}" --exclude=.git -czvf "${VERSIONED_PACKAGE_NAME}" .
    - echo "Package ${VERSIONED_PACKAGE_NAME} created successfully"
    - echo "Creating a stable latest copy"
    - cp "${VERSIONED_PACKAGE_NAME}" "${LATEST_PACKAGE_NAME}"
    - echo "Created stable package ${LATEST_PACKAGE_NAME}"
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 hour

create_release:
  stage: release
  rules:
    - if: $CI_COMMIT_TAG
  needs:
    - job: build_package
      artifacts: true
  script:
    - echo "Creating GitLab Release ${CI_COMMIT_TAG}"
    - |
      RELEASE_DATA=$(cat << 'EOF'
      {
        "name": "Release ${CI_COMMIT_TAG}",
        "tag_name": "${CI_COMMIT_TAG}",
        "description": "Version ${CI_COMMIT_TAG}. Les notes de version completes sont dans le fichier CHANGELOG.md.",
        "assets": {
          "links": [
            {
              "name": "gitlab-monitor-${CI_COMMIT_TAG}.tar.gz",
              "url": "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/gitlab-monitor-${CI_COMMIT_TAG}.tar.gz?job=build_package",
              "link_type": "package"
            },
            {
              "name": "gitlab-monitor-latest.tar.gz",
              "url": "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/gitlab-monitor-latest.tar.gz?job=build_package",
              "link_type": "other"
            }
          ]
        }
      }
      EOF
      )
    - echo "Release data prepared"
    - |
      curl --fail --request POST \
        --header "PRIVATE-TOKEN: ${RELEASE_ACCESS_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "${RELEASE_DATA}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
---
stages:
  - build
  - release

build_package:
  stage: build
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - echo "Debugging file structure"
    - ls -la "${CI_PROJECT_DIR}"
    - VERSIONED_PACKAGE_NAME="gitlab-monitor-${CI_COMMIT_TAG}.tar.gz"
    - LATEST_PACKAGE_NAME="gitlab-monitor-latest.tar.gz"
    - echo "Archiving project files to a temporary location..."
    - |
      tar -C "${CI_PROJECT_DIR}" --exclude=.git -czvf \
        "/tmp/${VERSIONED_PACKAGE_NAME}" .
    - echo "Moving archive to project directory..."
    - mv "/tmp/${VERSIONED_PACKAGE_NAME}" "${CI_PROJECT_DIR}/"
    - echo "Package created successfully"
    - |
      cp "${CI_PROJECT_DIR}/${VERSIONED_PACKAGE_NAME}" \
        "${CI_PROJECT_DIR}/${LATEST_PACKAGE_NAME}"
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 hour

create_release:
  stage: release
  rules:
    - if: '$CI_COMMIT_TAG'
  needs:
    - job: build_package
      artifacts: true
  script:
    - echo "Creating release ${CI_COMMIT_TAG}"
    - |
      cat > release.json <<EOF
      {
        "name": "Release ${CI_COMMIT_TAG}",
        "tag_name": "${CI_COMMIT_TAG}"
      }
      EOF
    - |
      curl --fail --request POST \
        --header "PRIVATE-TOKEN: ${RELEASE_ACCESS_TOKEN}" \
        --header "Content-Type: application/json" \
        --data @release.json \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"

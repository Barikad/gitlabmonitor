# ==============================================================================
# GitLab CI/CD Pipeline for GitLabMonitor
# Utilise la méthode "Release Assets" pour une URL de téléchargement stable.
# ==============================================================================
stages:
  - build
  - release

# ==============================================================================
# JOB 1: Build the release package
# ==============================================================================
build_package:
  stage: build
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "--- Debugging file structure ---"
    - echo "CI_PROJECT_DIR is: ${CI_PROJECT_DIR}"
    - echo "Content of CI_PROJECT_DIR:"
    - ls -la "${CI_PROJECT_DIR}"
    - echo "--- End of debugging ---"
    - VERSIONED_PACKAGE_NAME="gitlab-monitor-${CI_COMMIT_TAG}.tar.gz"
    - LATEST_PACKAGE_NAME="gitlab-monitor-latest.tar.gz"
    # Archive tout le contenu de CI_PROJECT_DIR (.), en excluant le dossier .git
    - tar -C "${CI_PROJECT_DIR}" --exclude=.git -czvf "${VERSIONED_PACKAGE_NAME}" .
    - echo "Package ${VERSIONED_PACKAGE_NAME} created successfully."
    # Crée une copie avec un nom stable "latest"
    - cp "${VERSIONED_PACKAGE_NAME}" "${LATEST_PACKAGE_NAME}"
    - echo "Created stable package ${LATEST_PACKAGE_NAME}"
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 hour

# ==============================================================================
# JOB 2: Create the GitLab Release with the package as an asset
# ==============================================================================
create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG
  needs:
    - job: build_package
      artifacts: true
  script:
    - echo "Creating GitLab Release ${CI_COMMIT_TAG}..."
    - VERSIONED_PACKAGE_NAME="gitlab-monitor-${CI_COMMIT_TAG}.tar.gz"
    - LATEST_PACKAGE_NAME="gitlab-monitor-latest.tar.gz"
    - |
      release-cli create --name "Release ${CI_COMMIT_TAG}" --tag-name "${CI_COMMIT_TAG}" \
        --description "Version ${CI_COMMIT_TAG}. Les notes de version complètes sont dans le fichier CHANGELOG.md." \
        --assets-link "{\"name\":\"${VERSIONED_PACKAGE_NAME}\",\"url\":\"${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/${VERSIONED_PACKAGE_NAME}?job=build_package\",\"link_type\":\"package\"}" \
        --assets-link "{\"name\":\"${LATEST_PACKAGE_NAME}\",\"url\":\"${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/${LATEST_PACKAGE_NAME}?job=build_package\",\"link_type\":\"other\"}"

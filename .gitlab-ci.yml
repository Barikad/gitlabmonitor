create_release:
  stage: release
  rules:
    - if: '$CI_COMMIT_TAG'
  needs:
    - job: build_package
      artifacts: true
  script:
    - echo "--- Creating release with glab ---"
    - echo "CI_COMMIT_TAG: ${CI_COMMIT_TAG}"
    - echo "CI_PROJECT_URL: ${CI_PROJECT_URL}"
    - echo "--- Authenticating with GitLab ---"
    - glab auth login --hostname "${CI_SERVER_HOST}" --token "${RELEASE_ACCESS_TOKEN}"
    - echo "--- Creating release ---"
    - VERSIONED_ASSET="${CI_PROJECT_DIR}/gitlab-monitor-${CI_COMMIT_TAG}.tar.gz"
    - LATEST_ASSET="${CI_PROJECT_DIR}/gitlab-monitor-latest.tar.gz"
    - glab release create "${CI_COMMIT_TAG}" --name "Release ${CI_COMMIT_TAG}" --notes "Version ${CI_COMMIT_TAG}. Voir CHANGELOG.md." --asset "${VERSIONED_ASSET}" --asset "${LATEST_ASSET}"
    - echo "Release created successfully."

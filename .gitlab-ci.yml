# ==============================================================================
# GitLab CI/CD Pipeline for GitLabMonitor
# ==============================================================================
# This pipeline calls an external script to perform all actions.

stages:
  - build
  - release

# ==============================================================================
# JOB 1: Build the release package
# ==============================================================================
build_package:
  stage: build
  # The script is run using bash
  script:
    - /bin/bash ci/release.sh build
  rules:
    - if: $CI_COMMIT_TAG
  artifacts:
    # The artifact path is now predictable
    paths:
      - "gitlab-monitor-*.tar.gz"
    expire_in: 30 days

# ==============================================================================
# JOB 2: Publish the package and create the GitLab Release
# ==============================================================================
create_release:
  stage: release
  # The script needs curl, so we use an image that has it.
  image: curlimages/curl:latest
  script:
    - /bin/bash ci/release.sh release
  rules:
    - if: $CI_COMMIT_TAG
  needs:
    - job: build_package
      artifacts: true

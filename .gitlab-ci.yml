---
stages:
  - build
  - release

build_package:
  stage: build
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - echo "Debugging file structure"
    - ls -la "${CI_PROJECT_DIR}"
    - VERSIONED_PACKAGE_NAME="gitlab-monitor-${CI_COMMIT_TAG}.tar.gz"
    - LATEST_PACKAGE_NAME="gitlab-monitor-latest.tar.gz"
    - echo "Archiving project files"
    - |
      tar -C "${CI_PROJECT_DIR}" --exclude=.git -czvf \
        "${VERSIONED_PACKAGE_NAME}" .
    - echo "Package created successfully"
    - cp "${VERSIONED_PACKAGE_NAME}" "${LATEST_PACKAGE_NAME}"
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 hour

create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: '$CI_COMMIT_TAG'
  needs:
    - job: build_package
      artifacts: true
  script:
    - echo "--- Debugging Release Creation ---"
    - echo "CI_COMMIT_TAG: ${CI_COMMIT_TAG}"
    - echo "CI_PROJECT_ID: ${CI_PROJECT_ID}"
    - echo "CI_PROJECT_URL: ${CI_PROJECT_URL}"
    - echo "CI_JOB_TOKEN is present. Length: ${#CI_JOB_TOKEN}"
    - echo "--- Attempting to create release (verbose mode) ---"
    - |
      VERSIONED_ASSET="{\"name\":\"gitlab-monitor-${CI_COMMIT_TAG}.tar.gz\",\"url\":\"${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/gitlab-monitor-${CI_COMMIT_TAG}.tar.gz?job=build_package\",\"link_type\":\"package\"}"
      LATEST_ASSET="{\"name\":\"gitlab-monitor-latest.tar.gz\",\"url\":\"${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/gitlab-monitor-latest.tar.gz?job=build_package\",\"link_type\":\"other\"}"
      release-cli create --name "Release ${CI_COMMIT_TAG}" \
        --tag-name "${CI_COMMIT_TAG}" \
        --description "Version ${CI_COMMIT_TAG}. Voir CHANGELOG.md." \
        --assets-link "${VERSIONED_ASSET}" \
        --assets-link "${LATEST_ASSET}" \
        --verbose
    - RELEASE_EXIT_CODE=$?
    - echo "Release-cli command finished with exit code: ${RELEASE_EXIT_CODE}"
    - |
      if [ ${RELEASE_EXIT_CODE} -ne 0 ]; then
        echo "ERROR: Release creation failed!"
        exit 1
      fi
    - echo "Release created successfully."

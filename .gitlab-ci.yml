---
stages:
  - build
  - release

build_package:
  stage: build
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    - echo "Debugging file structure"
    - ls -la "${CI_PROJECT_DIR}"
    - VERSIONED_PACKAGE_NAME="gitlab-monitor-${CI_COMMIT_TAG}.tar.gz"
    - LATEST_PACKAGE_NAME="gitlab-monitor-latest.tar.gz"
    - echo "Archiving project files"
    - |
      tar -C "${CI_PROJECT_DIR}" --exclude=.git -czvf \
        "${VERSIONED_PACKAGE_NAME}" .
    - echo "Package created successfully"
    - cp "${VERSIONED_PACKAGE_NAME}" "${LATEST_PACKAGE_NAME}"
  artifacts:
    paths:
      - "*.tar.gz"
    expire_in: 1 hour

create_release:
  stage: release
  image: curlimages/curl:latest  # Ensure curl is available
  rules:
    - if: '$CI_COMMIT_TAG'
  needs:
    - job: build_package
      artifacts: true
  script:
    - echo "Creating release ${CI_COMMIT_TAG}"
    # Correct artifact URL using JOB_ID
    - ARTIFACT_BASE_URL="${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw"
    - URL1="${ARTIFACT_BASE_URL}/gitlab-monitor-${CI_COMMIT_TAG}.tar.gz"
    - URL2="${ARTIFACT_BASE_URL}/gitlab-monitor-latest.tar.gz"
    - |
      cat > release.json <<EOF
      {
        "name": "Release ${CI_COMMIT_TAG}",
        "tag_name": "${CI_COMMIT_TAG}",
        "description": "Version ${CI_COMMIT_TAG}",
        "assets": {
          "links": [
            {
              "name": "gitlab-monitor-${CI_COMMIT_TAG}.tar.gz",
              "url": "${URL1}",
              "link_type": "package"
            },
            {
              "name": "gitlab-monitor-latest.tar.gz",
              "url": "${URL2}",
              "link_type": "other"
            }
          ]
        }
      }
      EOF
    - |
      curl --fail --request POST \
        --header "PRIVATE-TOKEN: ${RELEASE_ACCESS_TOKEN}" \
        --header "Content-Type: application/json" \
        --data @release.json \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
